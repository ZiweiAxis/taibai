# 接入验证指南

**目的**：使用太白子模块提供的**验证用智能体**，对「天枢 + 谛听」集成进行接入验证，确保常见集成场景可跑通。

## 1. 前置条件

- **天枢（tianshu）** 已部署，并暴露：
  - 发现：`GET /.well-known/tianshu-matrix` 或 `GET /api/v1/discovery`，返回 `matrix_homeserver`、可选 `api_base`。
  - 若支持 HTTP 注册/心跳：`POST /api/v1/agents/register`、`POST /api/v1/agents/heartbeat`（以天枢实际路由为准）。
- **谛听（diting）** 已部署，并暴露审计上报 URL（如 `DITING_AUDIT_URL`）。
- 验证智能体运行环境可访问上述端点（网络/防火墙放行）。

## 2. 验证智能体做什么

`taibai/examples/verification_agent/main.py` 依次执行：

| 步骤 | 动作 | 验证点 |
|------|------|--------|
| 1 | 发现天枢 | GET 发现 URL，解析 `matrix_homeserver` / `api_base` |
| 2 | 注册或使用已有 agent_id | 若天枢提供注册 API 则调用；否则使用环境变量 `VERIFICATION_AGENT_ID`（需事先在天枢侧完成人工/脚本注册） |
| 3 | 心跳 | 向天枢上报在线（若 API 存在） |
| 4 | 上报一条操作 | POST 至谛听审计 URL，携带 agent_id、action_type、timestamp 等 |

全部成功则退出码 0，任一步失败则非 0 并打印错误，便于 CI 或人工排查。

## 3. 配置

在 `taibai/examples/verification_agent/` 下创建 `.env`（可复制 `.env.example`）：

```bash
# 天枢：发现与 API（二选一或同时）
TIANSHU_API_BASE=http://localhost:8080   # 天枢 API 根，用于 discovery + 注册/心跳
# 或仅 Matrix（发现返回的 matrix_homeserver）
MATRIX_HOMESERVER=http://matrix:8008

# 谛听：审计上报
DITING_AUDIT_URL=http://diting-host:port/api/audit  # 以谛听实际路径为准

# 若天枢暂无注册 API，使用已存在的 agent_id 做心跳与上报验证
# VERIFICATION_AGENT_ID=agent-xxx
```

## 4. 运行

```bash
cd ziwei/taibai/examples/verification_agent
pip install -r requirements.txt
python main.py
echo "Exit: $?"
```

## 5. 常见场景

- **仅验证发现 + 审计上报**：配置 `TIANSHU_API_BASE`、`DITING_AUDIT_URL`，并设置 `VERIFICATION_AGENT_ID`（事先在天枢侧注册好）；脚本将跳过注册、执行发现 → 心跳（若支持）→ 上报。
- **全流程验证（含注册）**：天枢暴露注册 API 时，不设 `VERIFICATION_AGENT_ID`，脚本将尝试注册后再心跳与上报。
- **CI 集成**：在流水线中启动天枢与谛听（如 docker-compose），再执行上述 `python main.py`，以退出码判断是否通过。

## 6. 与太白协议的关系

验证智能体使用的字段与行为与紫微技术方案 §4（太白协议）对齐：agent_id、owner、操作上报载荷等；具体事件类型（如 `m.agent.action`）在 SDK 的 `protocol.py` 中定义，便于后续扩展为完整 Matrix 事件上报。
